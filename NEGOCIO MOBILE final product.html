<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEGOCIO Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Satisfy&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #f5f2e9;
            --bg-white: #ffffff;
            --accent-secondary: #e879f9;
            --text-main: #1e293b;
            --text-light: #64748b;
            --sectionPadding: clamp(4rem, 10vh, 6rem);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg-deep);
            color: var(--text-main);
            margin: 0;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            width: 100%;
        }

        .font-script { font-family: 'Satisfy', cursive; }

        section {
            padding: var(--sectionPadding) 1rem;
            padding-bottom: calc(7.5rem + var(--safe-bottom));
            width: 100%;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
        }

        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(4.5rem + var(--safe-top));
            padding-top: var(--safe-top);
            background: rgba(245, 242, 233, 0.95);
            backdrop-filter: blur(12px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 1rem;
            padding-right: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding-bottom: var(--safe-bottom);
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            z-index: 100;
            border-top: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }

        .nav-items-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 3.5rem;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 0.65rem;
            font-weight: 800;
            background: none;
            border: none;
        }

        .nav-btn.active { color: var(--accent-secondary); }

        .fab {
            position: fixed;
            right: 1.25rem;
            bottom: calc(7rem + var(--safe-bottom));
            width: 3.75rem;
            height: 3.75rem;
            background: var(--accent-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 25px rgba(232, 121, 249, 0.4);
            z-index: 90;
        }

        .listing-card {
            background: var(--bg-white);
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .category-bar {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            scrollbar-width: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }

        .cat-pill {
            padding: 0.5rem 1rem;
            background: var(--bg-white);
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-light);
            border: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .cat-pill.active {
            background: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 42rem;
            border-radius: 2rem 2rem 0 0;
            padding: 1.5rem;
            padding-bottom: calc(2.5rem + var(--safe-bottom));
            max-height: 92vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        input, select, textarea {
            width: 100%;
            padding: 0.85rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            font-size: 16px; 
            margin-bottom: 0.75rem;
            background: #f8fafc;
        }

        .gender-btn {
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--text-main);
            transition: all 0.2s ease;
        }

        .gender-btn.selected {
            background: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        #toast {
            position: fixed;
            bottom: calc(7.5rem + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(10rem);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            z-index: 1000;
        }

        #adminPanel {
            position: fixed;
            inset: 0;
            background: #0f172a;
            color: white;
            z-index: 500;
            padding: calc(2rem + var(--safe-top)) 1.5rem calc(2rem + var(--safe-bottom));
            overflow-y: auto;
        }

        .img-preview-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
        }
        .img-preview-item {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1 class="text-2xl font-script text-fuchsia-500 italic">Negocio</h1>
        <div id="authWrapper">
            <div id="verifiedStatus" class="hidden flex items-center gap-2">
                <span id="userGenderBadge" class="bg-slate-800 text-white px-2 py-0.5 rounded text-[8px] font-black uppercase"></span>
                <div class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-black border border-emerald-100 flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                    VERIFIED
                </div>
            </div>
            <div id="verificationContainer">
                <div class="pe_verify_email" data-client-id="13401266232106403409">
                    <script src="https://www.phone.email/verify_email_v1.js" async></script>
                </div>
            </div>
        </div>
    </header>

    <section id="marketplace">
        <div class="container mx-auto">
            <div class="w-full space-y-4">
                <div class="category-bar">
                    <button onclick="setFilter('ALL')" class="cat-pill active">All Assets</button>
                    <button onclick="setFilter('Electronics')" class="cat-pill">Electronics</button>
                    <button onclick="setFilter('Clothing')" class="cat-pill">Clothing</button>
                    <button onclick="setFilter('Accessories')" class="cat-pill">Accessories</button>
                    <button onclick="setFilter('Beauty')" class="cat-pill">Beauty</button>
                    <button onclick="setFilter('Books')" class="cat-pill">Books</button>
                    <button onclick="setFilter('Daily needs')" class="cat-pill">Needs</button>
                </div>

                <div class="flex justify-between items-center px-4">
                    <h2 id="viewTitle" class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Global Feed</h2>
                    <span id="itemCount" class="text-[10px] font-black text-fuchsia-500">0 ITEMS</span>
                </div>
            </div>

            <ul id="itemsContainer" class="card-grid px-4 mt-6"></ul>

            <div id="emptyState" class="hidden py-20 text-center space-y-4">
                <div class="text-5xl opacity-20">ðŸ“¡</div>
                <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">No signals detected</p>
            </div>
        </div>
    </section>

    <!-- Identity Preference Modal (Post-Verification) -->
    <div id="genderModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-black uppercase mb-2">Final Step</h3>
            <p class="text-xs text-slate-500 mb-8 font-bold leading-relaxed">
                Choose your gender to personalize your feed and filter clothing listings.
            </p>
            <div class="space-y-3">
                <button onclick="setIdentity('Male')" class="gender-btn">Male</button>
                <button onclick="setIdentity('Female')" class="gender-btn">Female</button>
                <button onclick="setIdentity('Other')" class="gender-btn">Other</button>
            </div>
        </div>
    </div>

    <!-- Selling Modal -->
    <div id="sellingModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-black uppercase tracking-tight">Register Asset</h3>
                <button onclick="toggleModal('sellingModal', false)" class="text-3xl text-slate-300">&times;</button>
            </div>
            <form id="itemForm" class="space-y-1">
                <input type="text" id="itemName" required placeholder="Asset Title">
                <input type="number" id="itemPrice" required placeholder="Value (â‚¹)">
                <select id="itemCategory" onchange="toggleClothingGender(this.value)">
                    <option value="Electronics">Electronics</option>
                    <option value="Clothing">Clothing</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Beauty">Beauty</option>
                    <option value="Books">Books</option>
                    <option value="Daily needs">Daily needs</option>
                </select>

                <div id="clothingTargetGroup" class="hidden p-4 bg-fuchsia-50 rounded-xl mb-3">
                    <p class="text-[9px] font-black text-fuchsia-400 uppercase mb-2">Target Audience</p>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-xs font-bold uppercase"><input type="radio" name="targetGender" value="Male"> Male</label>
                        <label class="flex items-center gap-2 text-xs font-bold uppercase"><input type="radio" name="targetGender" value="Female" checked> Female</label>
                        <label class="flex items-center gap-2 text-xs font-bold uppercase"><input type="radio" name="targetGender" value="Other"> Other</label>
                    </div>
                </div>

                <div class="flex gap-6 py-2">
                    <label class="flex items-center gap-2 font-black text-xs uppercase"><input type="radio" name="itemCondition" value="unused" checked> Unused</label>
                    <label class="flex items-center gap-2 font-black text-xs uppercase"><input type="radio" name="itemCondition" value="used"> Used</label>
                </div>
                
                <input type="file" id="itemImage" accept="image/*" multiple class="text-xs">
                <div class="img-preview-container" id="imgPreview"></div>
                
                <input type="email" id="itemEmail" required placeholder="Contact Email">
                <input type="tel" id="itemPhone" placeholder="Secure Line (Optional)">
                <textarea id="itemDesc" rows="3" placeholder="Description / Intelligence Report"></textarea>
                
                <button type="submit" class="w-full py-4 bg-fuchsia-500 text-white rounded-xl text-md font-black shadow-lg uppercase tracking-wider mt-4">Broadcast Listing</button>
            </form>
        </div>
    </div>

    <!-- Item Details Modal -->
    <div id="itemDetailsModal" class="modal-overlay hidden">
        <div class="modal-content !p-0 overflow-hidden">
            <div class="relative h-72 bg-slate-100">
                <button onclick="toggleModal('itemDetailsModal', false)" class="absolute top-4 right-4 z-20 bg-black/30 text-white w-10 h-10 rounded-full backdrop-blur-md">&times;</button>
                <img id="detailsImg" class="w-full h-full object-contain">
            </div>
            <div class="p-6">
                <div class="flex justify-between items-center mb-2">
                    <span id="detailsCategory" class="px-2 py-0.5 bg-amber-100 text-amber-800 rounded text-[9px] font-black uppercase"></span>
                    <span id="detailsCond" class="text-[9px] font-black text-slate-400 uppercase"></span>
                </div>
                <h2 id="detailsName" class="text-xl font-black text-slate-800 uppercase mb-1"></h2>
                <div id="detailsPrice" class="text-2xl font-black text-fuchsia-600 mb-4"></div>
                <p id="detailsDesc" class="text-slate-500 text-xs leading-relaxed mb-6 font-medium"></p>
                
                <div id="contactArea">
                    <button id="connectBtn" onclick="revealContact()" class="w-full py-4 bg-fuchsia-500 text-white rounded-xl text-md font-black shadow-lg uppercase">Connect with Seller</button>
                    <div id="contactInfo" class="hidden pt-4 space-y-2">
                        <p class="text-[10px] font-black text-slate-400 uppercase">Direct Access:</p>
                        <a id="detailsEmail" class="block font-bold text-slate-800 text-sm"></a>
                        <p id="detailsPhone" class="font-bold text-slate-800 text-sm"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="flex justify-between items-center mb-10">
            <h1 class="text-xl font-black text-amber-500 uppercase tracking-tighter">System Console</h1>
            <button onclick="window.toggleAdminView(false)" class="bg-slate-800 px-6 py-2 rounded-xl font-bold text-[10px] uppercase">Close</button>
        </div>
        <div class="space-y-8">
            <div>
                <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Moderate Assets</h2>
                <div id="adminList" class="space-y-3"></div>
            </div>
            <div>
                <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Access Logs (Blocked)</h2>
                <div id="blockedUsersList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-black uppercase">Search</h3>
                <button onclick="toggleModal('searchModal', false)" class="text-3xl text-slate-300">&times;</button>
            </div>
            <input type="text" id="searchInput" placeholder="Looking for something?" class="font-bold" oninput="handleSearch()">
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="window.adminClickCounter()" class="version-bar text-[8px] font-black text-slate-300 text-center py-2 uppercase tracking-widest cursor-pointer">Version 2.2.8</div>
        <div class="nav-items-container">
            <button onclick="setFilter('ALL')" class="nav-btn active"><span>HOME</span></button>
            <button onclick="toggleModal('searchModal', true)" class="nav-btn"><span>SEARCH</span></button>
        </div>
    </nav>

    <button onclick="handleNewListingClick()" class="fab">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3.5" d="M12 6v12m6-6H6"></path></svg>
    </button>

    <div id="toast" class="bg-slate-900 text-white px-6 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl">
        <span id="toastMsg">Updated</span>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, onSnapshot, getDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // State
        let items = [];
        let blockedUsers = [];
        let user = null;
        let currentFilter = 'ALL';
        let searchQuery = '';
        let currentImagesData = [];
        let clickCount = 0;
        let isAdminActive = false;
        
        const ADMIN_EMAIL = "km0334109@gmail.com";
        window.isUserVerified = false;
        window.verifiedEmail = null;
        window.userGender = null;

        // Firebase Configuration
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCfVmrY2rJIGkMVocdarjbQ30rEh78MwmY",
            authDomain: "negocios-8e8a4.firebaseapp.com",
            projectId: "negocios-8e8a4",
            storageBucket: "negocios-8e8a4.firebasestorage.app",
            messagingSenderId: "298423907311",
            appId: "1:298423907311:web:92b79b23776a4f56557c1a"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'negocio-v4';

        // UI Handlers
        window.showToast = (m) => { 
            const msg = document.getElementById('toastMsg'); 
            msg.textContent = m;
            const t = document.getElementById('toast');
            t.style.transform = "translateX(-50%) translateY(0)";
            setTimeout(() => t.style.transform = "translateX(-50%) translateY(10rem)", 2500);
        };

        window.toggleModal = (id, show) => {
            const m = document.getElementById(id);
            if(m) m.classList.toggle('hidden', !show);
            if(!show && id === 'sellingModal') document.getElementById('itemForm').reset();
        };

        window.toggleClothingGender = (val) => {
            document.getElementById('clothingTargetGroup').classList.toggle('hidden', val !== 'Clothing');
        };

        window.revealContact = () => {
            document.getElementById('connectBtn').classList.add('hidden');
            document.getElementById('contactInfo').classList.remove('hidden');
        };

        window.setFilter = (cat) => {
            currentFilter = cat;
            document.querySelectorAll('.cat-pill, .nav-btn').forEach(el => {
                const text = el.textContent.toUpperCase();
                el.classList.toggle('active', text.includes(cat.toUpperCase()) || (cat === 'ALL' && (text === 'HOME' || text === 'ALL ASSETS')));
            });
            document.getElementById('viewTitle').textContent = cat === 'ALL' ? 'Global Feed' : cat;
            updateUI();
        };

        window.handleSearch = () => { 
            searchQuery = document.getElementById('searchInput').value.toLowerCase(); 
            updateUI(); 
        };

        // Admin Functionality
        window.adminClickCounter = () => {
            clickCount++;
            if (clickCount >= 5) {
                clickCount = 0;
                const currentEmail = (window.verifiedEmail || "").toLowerCase().trim();
                if (currentEmail === ADMIN_EMAIL.toLowerCase()) {
                    window.toggleAdminView(true);
                    window.showToast('Welcome, Admin');
                } else {
                    window.showToast(`Access Denied: ${window.verifiedEmail || 'No Identity'}`);
                }
            } else {
                window.showToast(`${clickCount}/5 for Admin`);
            }
        };

        window.toggleAdminView = (show) => {
            isAdminActive = show;
            document.getElementById('adminPanel').classList.toggle('hidden', !show);
            if (show) renderAdmin();
        };

        const renderAdmin = () => {
            const list = document.getElementById('adminList');
            const blockedList = document.getElementById('blockedUsersList');
            if (!list || !blockedList) return;

            list.innerHTML = items.length ? '' : '<p class="text-[8px] font-bold text-slate-500 uppercase">Empty</p>';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-slate-900/50 p-4 rounded-xl flex items-center justify-between border border-slate-800';
                div.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-black text-[11px] uppercase text-white truncate">${item.name}</p>
                        <p class="text-[8px] text-slate-500 font-bold">${item.email}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="purgeItem('${item.id}')" class="bg-red-500/20 text-red-500 px-3 py-1.5 rounded-lg font-black text-[8px] uppercase border border-red-500/20">Purge</button>
                        <button onclick="blockUser('${item.sellerId}', '${item.email}')" class="bg-amber-500/20 text-amber-500 px-3 py-1.5 rounded-lg font-black text-[8px] uppercase border border-amber-500/20">Block</button>
                    </div>
                `;
                list.appendChild(div);
            });

            blockedList.innerHTML = blockedUsers.length ? '' : '<p class="text-[8px] font-bold text-slate-700 uppercase">No Restraints</p>';
            blockedUsers.forEach(block => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-900/30 rounded border border-slate-800';
                div.innerHTML = `
                    <span class="text-[8px] font-black text-slate-400 uppercase">${block.email}</span>
                    <button onclick="unblockUser('${block.id}')" class="text-fuchsia-400 text-[8px] font-black uppercase">Unblock</button>
                `;
                blockedList.appendChild(div);
            });
        };

        window.purgeItem = async (id) => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'listings', id));
            window.showToast('Asset Purged');
        };

        window.blockUser = async (uid, email) => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'blocked_users', uid), { email, blockedAt: Date.now() });
            window.showToast('User Restricted');
        };

        window.unblockUser = async (uid) => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'blocked_users', uid));
            window.showToast('Restriction Lifted');
        };

        // Verification & Identity
        window.phoneEmailReceiver = async (userObj) => {
            if (userObj && userObj.user_email_id) {
                window.isUserVerified = true;
                window.verifiedEmail = userObj.user_email_id;
                document.getElementById('verificationContainer').classList.add('hidden');
                document.getElementById('verifiedStatus').classList.remove('hidden');
                if (user) checkProfile(user);
                window.showToast('Identity Confirmed');
            }
        };

        const checkProfile = async (currUser) => {
            const profileRef = doc(db, 'artifacts', appId, 'users', currUser.uid, 'profile', 'settings');
            const docSnap = await getDoc(profileRef);
            if (docSnap.exists()) {
                window.userGender = docSnap.data().gender;
                updateGenderBadge();
                updateUI();
            } else if (window.isUserVerified) {
                window.toggleModal('genderModal', true);
            }
        };

        window.setIdentity = async (gender) => {
            if (!user) return;
            window.userGender = gender;
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'settings');
                await setDoc(profileRef, { gender, updatedAt: Date.now() });
                window.toggleModal('genderModal', false);
                updateGenderBadge();
                updateUI();
                window.showToast(`Mode: ${gender}`);
            } catch (e) { window.showToast('Profile Error'); }
        };

        const updateGenderBadge = () => {
            const badge = document.getElementById('userGenderBadge');
            if (window.userGender) {
                badge.textContent = window.userGender;
                badge.classList.remove('hidden');
            }
        };

        // UI Core Logic
        const updateUI = () => {
            const filtered = items.filter(i => {
                if (i.category === 'Clothing' && i.targetGender === 'Female') {
                    if (!window.userGender || window.userGender !== 'Female') return false;
                }
                if (currentFilter !== 'ALL' && i.category !== currentFilter) return false;
                if (searchQuery && !i.name.toLowerCase().includes(searchQuery)) return false;
                return true;
            });

            const container = document.getElementById('itemsContainer');
            const empty = document.getElementById('emptyState');
            document.getElementById('itemCount').textContent = `${filtered.length} ITEMS`;

            if (!filtered.length) {
                empty.classList.remove('hidden');
                container.innerHTML = '';
            } else {
                empty.classList.add('hidden');
                container.innerHTML = '';
                filtered.forEach(item => {
                    const li = document.createElement('li');
                    li.onclick = () => window.openItemDetails(item.id);
                    li.innerHTML = `
                        <div class="listing-card">
                            <div class="aspect-square bg-slate-100 relative overflow-hidden flex items-center justify-center">
                                ${item.images?.[0] ? `<img src="${item.images[0]}" class="w-full h-full object-cover">` : '<div class="text-[8px] font-black opacity-20 uppercase">No Visual</div>'}
                                ${item.targetGender ? `<div class="absolute top-2 right-2 bg-fuchsia-500 text-white text-[7px] px-1.5 py-0.5 rounded font-black uppercase">${item.targetGender}</div>` : ''}
                            </div>
                            <div class="p-3">
                                <span class="text-[8px] font-black text-amber-600 uppercase tracking-widest">${item.category}</span>
                                <h3 class="text-[11px] font-black text-slate-800 uppercase truncate mb-1">${item.name}</h3>
                                <span class="text-sm font-black text-fuchsia-600">â‚¹${parseInt(item.price).toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(li);
                });
            }
            if (isAdminActive) renderAdmin();
        };

        window.openItemDetails = (id) => {
            const item = items.find(i => i.id === id);
            if(!item) return;
            document.getElementById('detailsImg').src = item.images?.[0] || '';
            document.getElementById('detailsName').textContent = item.name;
            document.getElementById('detailsCategory').textContent = item.category;
            document.getElementById('detailsCond').textContent = item.condition || 'used';
            document.getElementById('detailsPrice').textContent = `â‚¹${parseInt(item.price).toLocaleString()}`;
            document.getElementById('detailsDesc').textContent = item.description || 'No detailed report available.';
            const emailLink = document.getElementById('detailsEmail');
            emailLink.textContent = item.email;
            emailLink.href = `mailto:${item.email}`;
            document.getElementById('detailsPhone').textContent = item.phone || '';
            document.getElementById('connectBtn').classList.remove('hidden');
            document.getElementById('contactInfo').classList.add('hidden');
            window.toggleModal('itemDetailsModal', true);
        };

        window.handleNewListingClick = () => {
            if (!window.isUserVerified) return window.showToast('Identity Check Required');
            window.toggleModal('sellingModal', true);
        };

        // Form Logic
        document.getElementById('itemImage').addEventListener('change', function() {
            const preview = document.getElementById('imgPreview');
            preview.innerHTML = '';
            currentImagesData = [];
            Array.from(this.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImagesData.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result; img.className = 'img-preview-item';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!user) return;
            const blockSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'blocked_users', user.uid));
            if (blockSnap.exists()) return window.showToast('Account Restricted');

            const cat = document.getElementById('itemCategory').value;
            const newItem = {
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                category: cat,
                targetGender: cat === 'Clothing' ? document.querySelector('input[name="targetGender"]:checked').value : null,
                condition: document.querySelector('input[name="itemCondition"]:checked').value,
                description: document.getElementById('itemDesc').value,
                email: document.getElementById('itemEmail').value,
                phone: document.getElementById('itemPhone').value,
                images: [...currentImagesData],
                approved: true,
                sellerId: user.uid,
                createdAt: Date.now()
            };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'listings'), newItem);
                window.toggleModal('sellingModal', false);
                window.showToast('Asset Broadcasted');
            } catch (err) { window.showToast('Broadcast Failed'); }
        });

        // App Init
        const init = async () => {
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'listings'), (snap) => {
                        items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        updateUI();
                    });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'blocked_users'), (snap) => {
                        blockedUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (isAdminActive) renderAdmin();
                    });
                    if (window.isUserVerified) checkProfile(user);
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        };

        init();
    </script>
</body>
</html>
