<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEGOCIO Marketplace | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Satisfy&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #f5f2e9;
            --bg-white: #ffffff;
            --accent-secondary: #e879f9;
            --text-main: #1e293b;
            --text-light: #64748b;
            --sectionPadding: clamp(4rem, 10vh, 6rem);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg-deep);
            color: var(--text-main);
            margin: 0;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            width: 100%;
        }

        .font-script { font-family: 'Satisfy', cursive; }
        section {
            padding: var(--sectionPadding) 1rem;
            padding-bottom: calc(7.5rem + var(--safe-bottom));
            width: 100%;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
        }

        .app-header {
            position: fixed;
            top: 0; left: 0; width: 100%;
            height: calc(4.5rem + var(--safe-top));
            padding-top: var(--safe-top);
            background: rgba(245, 242, 233, 0.95);
            backdrop-filter: blur(12px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 1rem; padding-right: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            padding-bottom: var(--safe-bottom);
            background: var(--bg-white);
            display: flex; flex-direction: column;
            z-index: 100;
            border-top: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }

        .nav-items-container {
            display: flex; justify-content: space-around;
            align-items: center; height: 3.5rem;
        }

        .nav-btn {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: var(--text-light); font-size: 0.65rem;
            font-weight: 800; background: none; border: none;
            transition: all 0.2s ease;
        }

        .nav-btn.active { color: var(--accent-secondary); }

        .fab {
            position: fixed;
            right: 1.25rem;
            bottom: calc(7rem + var(--safe-bottom));
            width: 3.75rem; height: 3.75rem;
            background: var(--accent-secondary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 8px 25px rgba(232, 121, 249, 0.4);
            z-index: 90;
        }

        .listing-card {
            background: var(--bg-white);
            border-radius: 1.25rem; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            height: 100%; display: flex; flex-direction: column;
        }

        .category-bar {
            width: 100%; overflow-x: auto; white-space: nowrap;
            display: flex; gap: 0.5rem; padding: 0.5rem 1rem;
            scrollbar-width: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }

        .cat-pill {
            padding: 0.5rem 1rem; background: var(--bg-white);
            border-radius: 2rem; font-size: 0.75rem; font-weight: 700;
            color: var(--text-light); border: 1px solid #e2e8f0; flex-shrink: 0;
        }

        .cat-pill.active {
            background: var(--accent-secondary); color: white; border-color: var(--accent-secondary);
        }

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 200; display: flex; justify-content: center; align-items: flex-end;
        }

        .modal-content {
            background: white; width: 100%; max-width: 42rem;
            border-radius: 2rem 2rem 0 0; padding: 1.5rem;
            padding-bottom: calc(2.5rem + var(--safe-bottom));
            max-height: 92vh; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        input, select, textarea {
            width: 100%; padding: 0.85rem; border-radius: 0.75rem;
            border: 1px solid #e2e8f0; font-size: 16px; margin-bottom: 0.75rem;
            background: #f8fafc;
        }

        #toast {
            position: fixed;
            bottom: calc(7.5rem + var(--safe-bottom));
            left: 50%; transform: translateX(-50%) translateY(10rem);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; z-index: 1000;
        }

        .img-preview-container {
            display: flex; gap: 8px; overflow-x: auto; padding: 4px 0;
        }
        .img-preview-item {
            width: 60px; height: 60px; object-fit: cover;
            border-radius: 8px; border: 1px solid #ddd;
        }

        .admin-table {
            width: 100%; border-collapse: separate; border-spacing: 0 0.5rem;
        }
        .admin-table tr { background: white; border-radius: 0.5rem; }
        .admin-table td { padding: 1rem; }
        .admin-table td:first-child { border-radius: 0.75rem 0 0 0.75rem; }
        .admin-table td:last-child { border-radius: 0 0.75rem 0.75rem 0; }
    </style>
</head>
<body>

    <header class="app-header">
        <h1 class="text-2xl font-script text-fuchsia-500 italic">Negocio</h1>
        <div id="authWrapper">
            <div id="verifiedStatus" class="hidden flex items-center gap-2">
                <span id="userGenderBadge" class="bg-slate-800 text-white px-2 py-0.5 rounded text-[8px] font-black uppercase"></span>
                <div class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-black border border-emerald-100 flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                    VERIFIED
                </div>
            </div>
            <div id="verificationContainer">
                <div class="pe_verify_email" data-client-id="13401266232106403409">
                    <script src="https://www.phone.email/verify_email_v1.js" async></script>
                </div>
            </div>
        </div>
    </header>

    <!-- Marketplace View -->
    <section id="marketplaceView">
        <div class="container mx-auto">
            <div class="w-full space-y-4">
                <div class="category-bar">
                    <button onclick="setFilter('ALL')" class="cat-pill active">All Assets</button>
                    <button onclick="setFilter('Electronics')" class="cat-pill">Electronics</button>
                    <button onclick="setFilter('Clothing')" class="cat-pill">Clothing</button>
                    <button onclick="setFilter('Accessories')" class="cat-pill">Accessories</button>
                    <button onclick="setFilter('Beauty')" class="cat-pill">Beauty</button>
                    <button onclick="setFilter('Books')" class="cat-pill">Books</button>
                    <button onclick="setFilter('Daily needs')" class="cat-pill">Needs</button>
                </div>

                <div class="flex justify-between items-center px-4">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Global Feed</h2>
                    <span id="itemCount" class="text-[10px] font-black text-fuchsia-500">0 ITEMS</span>
                </div>
            </div>

            <ul id="itemsContainer" class="card-grid px-4 mt-6"></ul>

            <div id="emptyState" class="hidden py-20 text-center space-y-4">
                <div class="text-5xl opacity-20">ðŸ“¡</div>
                <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">No signals detected</p>
            </div>
        </div>
    </section>

    <!-- Admin Console View -->
    <section id="adminView" class="hidden">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-2xl font-black uppercase">Admin Console</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Database Moderation</p>
                </div>
                <div class="text-right">
                    <p id="adminStats" class="text-xl font-black text-fuchsia-500">0</p>
                    <p class="text-[8px] font-black text-slate-400 uppercase">Live Listings</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead class="text-[9px] font-black text-slate-400 uppercase">
                        <tr>
                            <th class="text-left p-4">Asset</th>
                            <th class="text-left p-4">Seller</th>
                            <th class="text-left p-4">Date</th>
                            <th class="text-right p-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                        <!-- Admin rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Identity Preference Modal -->
    <div id="genderModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-black uppercase mb-2">Final Step</h3>
            <p class="text-xs text-slate-500 mb-8 font-bold leading-relaxed">
                Choose your gender to personalize your feed.
            </p>
            <div class="space-y-3">
                <button onclick="setIdentity('Male')" class="w-full py-4 bg-slate-100 rounded-xl font-bold uppercase text-xs">Male</button>
                <button onclick="setIdentity('Female')" class="w-full py-4 bg-slate-100 rounded-xl font-bold uppercase text-xs">Female</button>
                <button onclick="setIdentity('Other')" class="w-full py-4 bg-slate-100 rounded-xl font-bold uppercase text-xs">Other</button>
            </div>
        </div>
    </div>

    <!-- Selling Modal -->
    <div id="sellingModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-black uppercase tracking-tight">Register Asset</h3>
                <button onclick="toggleModal('sellingModal', false)" class="text-3xl text-slate-300">&times;</button>
            </div>
            <form id="itemForm" class="space-y-1">
                <input type="text" id="itemName" required placeholder="Asset Title">
                <input type="number" id="itemPrice" required placeholder="Value (â‚¹)">
                <select id="itemCategory" onchange="toggleClothingGender(this.value)">
                    <option value="Electronics">Electronics</option>
                    <option value="Clothing">Clothing</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Beauty">Beauty</option>
                    <option value="Books">Books</option>
                    <option value="Daily needs">Daily needs</option>
                </select>

                <div id="clothingTargetGroup" class="hidden p-4 bg-fuchsia-50 rounded-xl mb-3">
                    <p class="text-[9px] font-black text-fuchsia-400 uppercase mb-2">Target Audience</p>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-xs font-bold uppercase"><input type="radio" name="targetGender" value="Male"> Male</label>
                        <label class="flex items-center gap-2 text-xs font-bold uppercase"><input type="radio" name="targetGender" value="Female" checked> Female</label>
                    </div>
                </div>

                <div class="flex gap-6 py-2">
                    <label class="flex items-center gap-2 font-black text-xs uppercase"><input type="radio" name="itemCondition" value="unused" checked> Unused</label>
                    <label class="flex items-center gap-2 font-black text-xs uppercase"><input type="radio" name="itemCondition" value="used"> Used</label>
                </div>
                
                <input type="file" id="itemImage" accept="image/*" class="text-xs">
                <div class="img-preview-container" id="imgPreview"></div>
                
                <input type="email" id="itemEmail" required placeholder="Contact Email">
                <textarea id="itemDesc" rows="3" placeholder="Description"></textarea>
                
                <button type="submit" id="submitBtn" class="w-full py-4 bg-fuchsia-500 text-white rounded-xl text-md font-black shadow-lg uppercase tracking-wider mt-4 disabled:opacity-50">Broadcast Listing</button>
            </form>
        </div>
    </div>

    <!-- Item Details Modal -->
    <div id="itemDetailsModal" class="modal-overlay hidden">
        <div class="modal-content !p-0 overflow-hidden">
            <div class="relative h-72 bg-slate-100">
                <button onclick="toggleModal('itemDetailsModal', false)" class="absolute top-4 right-4 z-20 bg-black/30 text-white w-10 h-10 rounded-full backdrop-blur-md">&times;</button>
                <img id="detailsImg" class="w-full h-full object-contain">
            </div>
            <div class="p-6">
                <span id="detailsCategory" class="px-2 py-0.5 bg-amber-100 text-amber-800 rounded text-[9px] font-black uppercase"></span>
                <h2 id="detailsName" class="text-xl font-black text-slate-800 uppercase mt-2"></h2>
                <div id="detailsPrice" class="text-2xl font-black text-fuchsia-600 mb-4"></div>
                <p id="detailsDesc" class="text-slate-500 text-xs leading-relaxed mb-6"></p>
                <a id="detailsEmailLink" class="block w-full py-4 bg-fuchsia-500 text-white rounded-xl text-center font-black uppercase">Contact Seller</a>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-content !pb-6">
            <h3 id="confirmTitle" class="text-lg font-black uppercase mb-4">Confirm Action</h3>
            <p id="confirmMsg" class="text-sm text-slate-500 mb-6 font-medium">Are you sure you want to perform this action?</p>
            <div class="flex gap-4">
                <button id="confirmBtn" class="flex-1 py-3 bg-red-500 text-white font-black uppercase text-xs rounded-xl">Confirm</button>
                <button onclick="toggleModal('confirmModal', false)" class="flex-1 py-3 bg-slate-100 font-black uppercase text-xs rounded-xl">Cancel</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-items-container">
            <button onclick="switchTab('marketplace')" id="navHome" class="nav-btn active">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>HOME</span>
            </button>
            <button onclick="switchTab('admin')" id="navAdmin" class="nav-btn hidden">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>ADMIN</span>
            </button>
        </div>
    </nav>

    <button onclick="handleNewListingClick()" class="fab" id="mainFab">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3.5" d="M12 6v12m6-6H6"></path></svg>
    </button>

    <div id="toast" class="bg-slate-900 text-white px-6 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl max-w-[90vw] text-center">
        <span id="toastMsg">Updated</span>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, onSnapshot, getDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const ADMIN_EMAIL = 'km0334109@gmail.com';
        const firebaseConfig = {
            apiKey: "AIzaSyCfVmrY2rJIGkMVocdarjbQ30rEh78MwmY",
            authDomain: "negocios-8e8a4.firebaseapp.com",
            projectId: "negocios-8e8a4",
            storageBucket: "negocios-8e8a4.firebasestorage.app",
            messagingSenderId: "298423907311",
            appId: "1:298423907311:web:92b79b23776a4f56557c1a"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'negocio-v4';

        let items = [];
        let blockedUsers = [];
        let user = null;
        let currentFilter = 'ALL';
        let currentImagesData = [];
        let activeTab = 'marketplace';

        window.showToast = (m) => { 
            const msg = document.getElementById('toastMsg'); 
            msg.textContent = m;
            const t = document.getElementById('toast');
            t.style.transform = "translateX(-50%) translateY(0)";
            setTimeout(() => t.style.transform = "translateX(-50%) translateY(10rem)", 4000);
        };

        window.toggleModal = (id, show) => {
            const m = document.getElementById(id);
            if(m) m.classList.toggle('hidden', !show);
        };

        window.toggleClothingGender = (val) => {
            document.getElementById('clothingTargetGroup').classList.toggle('hidden', val !== 'Clothing');
        };

        window.switchTab = (tab) => {
            if (tab === 'admin') {
                if (!window.isUserVerified || window.verifiedEmail !== ADMIN_EMAIL) {
                    window.showToast("ACCESS DENIED: SECURE ZONE");
                    return;
                }
            }

            activeTab = tab;
            document.getElementById('marketplaceView').classList.toggle('hidden', tab !== 'marketplace');
            document.getElementById('adminView').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('mainFab').classList.toggle('hidden', tab === 'admin');
            
            document.getElementById('navHome').classList.toggle('active', tab === 'marketplace');
            document.getElementById('navAdmin').classList.toggle('active', tab === 'admin');
            
            if (tab === 'admin') updateAdminUI();
        };

        const updateAdminVisibilityUI = () => {
            const adminBtn = document.getElementById('navAdmin');
            if (window.isUserVerified && window.verifiedEmail === ADMIN_EMAIL) {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }
        };

        async function processImage(base64) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, 600 / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.5));
                };
            });
        }

        document.getElementById('itemImage').addEventListener('change', function() {
            const file = this.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const compressed = await processImage(e.target.result);
                currentImagesData = [compressed];
                document.getElementById('imgPreview').innerHTML = `<img src="${compressed}" class="img-preview-item">`;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!user) return window.showToast("Wait for authentication...");

            // BLOCK CHECK
            if (blockedUsers.some(b => b.id === user.uid)) {
                return window.showToast("BLOCKED: Access to broadcasting revoked.");
            }
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = "Broadcasting...";

            const cat = document.getElementById('itemCategory').value;
            const newItem = {
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                category: cat,
                targetGender: cat === 'Clothing' ? document.querySelector('input[name="targetGender"]:checked').value : null,
                condition: document.querySelector('input[name="itemCondition"]:checked').value,
                description: document.getElementById('itemDesc').value,
                email: document.getElementById('itemEmail').value,
                images: currentImagesData,
                sellerId: user.uid,
                createdAt: Date.now()
            };

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'listings');
                await addDoc(colRef, newItem);
                window.toggleModal('sellingModal', false);
                window.showToast("Broadcasting successful!");
                document.getElementById('itemForm').reset();
                document.getElementById('imgPreview').innerHTML = '';
            } catch (err) {
                console.error(err);
                window.showToast("Network Error: Broadcast failed.");
            } finally {
                btn.disabled = false;
                btn.textContent = "Broadcast Listing";
            }
        });

        window.phoneEmailReceiver = (userObj) => {
            if (userObj?.user_email_id) {
                window.isUserVerified = true;
                window.verifiedEmail = userObj.user_email_id;
                document.getElementById('verificationContainer').classList.add('hidden');
                document.getElementById('verifiedStatus').classList.remove('hidden');
                updateAdminVisibilityUI();
                if (user) checkProfile(user);
            }
        };

        const checkProfile = async (currUser) => {
            const profileRef = doc(db, 'artifacts', appId, 'users', currUser.uid, 'profile', 'settings');
            const snap = await getDoc(profileRef);
            if (snap.exists()) {
                window.userGender = snap.data().gender;
                updateGenderBadge();
                updateUI();
            } else if (window.isUserVerified) {
                window.toggleModal('genderModal', true);
            }
        };

        window.setIdentity = async (gender) => {
            if(!user) return;
            window.userGender = gender;
            const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'settings');
            await setDoc(profileRef, { gender, updatedAt: Date.now() });
            window.toggleModal('genderModal', false);
            updateGenderBadge();
            updateUI();
        };

        const updateGenderBadge = () => {
            const badge = document.getElementById('userGenderBadge');
            badge.textContent = window.userGender;
            badge.classList.remove('hidden');
        };

        const updateUI = () => {
            if (activeTab === 'admin') {
                updateAdminUI();
                return;
            }

            const container = document.getElementById('itemsContainer');
            const filtered = items.filter(i => {
                // Filter out items from blocked users for public view
                if (blockedUsers.some(b => b.id === i.sellerId)) return false;
                if (i.category === 'Clothing' && i.targetGender === 'Female' && window.userGender !== 'Female') return false;
                if (currentFilter !== 'ALL' && i.category !== currentFilter) return false;
                return true;
            });

            document.getElementById('itemCount').textContent = `${filtered.length} ITEMS`;
            document.getElementById('emptyState').classList.toggle('hidden', filtered.length > 0);
            
            container.innerHTML = '';
            filtered.forEach(item => {
                const li = document.createElement('li');
                li.onclick = () => window.openItemDetails(item.id);
                li.innerHTML = `
                    <div class="listing-card">
                        <div class="aspect-square bg-slate-100 flex items-center justify-center overflow-hidden">
                            ${item.images?.[0] ? `<img src="${item.images[0]}" class="w-full h-full object-cover">` : '<span class="text-[8px] opacity-20">NO IMAGE</span>'}
                        </div>
                        <div class="p-3">
                            <span class="text-[8px] font-black text-amber-600 uppercase">${item.category}</span>
                            <h3 class="text-[11px] font-black text-slate-800 uppercase truncate">${item.name}</h3>
                            <span class="text-sm font-black text-fuchsia-600">â‚¹${item.price}</span>
                        </div>
                    </div>
                `;
                container.appendChild(li);
            });
        };

        const updateAdminUI = () => {
            const body = document.getElementById('adminTableBody');
            document.getElementById('adminStats').textContent = items.length;
            body.innerHTML = '';
            
            items.sort((a, b) => b.createdAt - a.createdAt).forEach(item => {
                const isBlocked = blockedUsers.some(b => b.id === item.sellerId);
                const tr = document.createElement('tr');
                if (isBlocked) tr.classList.add('opacity-40', 'bg-red-50');
                
                const date = new Date(item.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${item.images?.[0] || ''}" class="w-10 h-10 rounded-lg object-cover bg-slate-100">
                            <div>
                                <p class="text-[11px] font-black uppercase text-slate-800">${item.name}</p>
                                <p class="text-[9px] font-bold text-fuchsia-500 uppercase">â‚¹${item.price}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <p class="text-[10px] font-medium text-slate-500 lowercase">${item.email}</p>
                        <p class="text-[8px] font-black ${isBlocked ? 'text-red-500' : 'text-slate-400'} uppercase">
                            ${isBlocked ? 'BLACKLISTED' : item.sellerId.substring(0, 8) + '...'}
                        </p>
                    </td>
                    <td class="p-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">${date}</p>
                    </td>
                    <td class="p-4 text-right flex gap-2 justify-end">
                        <button onclick="window.confirmAction('delete', '${item.id}')" class="px-3 py-1 bg-red-50 text-red-500 rounded-full text-[9px] font-black uppercase border border-red-100 hover:bg-red-500 hover:text-white transition-colors">
                            Scrub
                        </button>
                        ${isBlocked ? 
                            `<button onclick="window.confirmAction('unblock', '${item.sellerId}')" class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-[9px] font-black uppercase border border-emerald-100">Restore</button>` : 
                            `<button onclick="window.confirmAction('block', '${item.sellerId}')" class="px-3 py-1 bg-slate-900 text-white rounded-full text-[9px] font-black uppercase border border-slate-900">Block</button>`
                        }
                    </td>
                `;
                body.appendChild(tr);
            });
        };

        window.confirmAction = (type, id) => {
            const title = document.getElementById('confirmTitle');
            const msg = document.getElementById('confirmMsg');
            const btn = document.getElementById('confirmBtn');

            if (type === 'delete') {
                title.textContent = "Scrub Asset";
                msg.textContent = "Permanently remove this listing from the database?";
                btn.onclick = () => window.deleteListing(id);
            } else if (type === 'block') {
                title.textContent = "Blacklist User";
                msg.textContent = "Prevent this seller from posting any further listings?";
                btn.onclick = () => window.blockUser(id);
            } else if (type === 'unblock') {
                title.textContent = "Restore User";
                msg.textContent = "Allow this user to broadcast assets again?";
                btn.onclick = () => window.unblockUser(id);
            }

            window.toggleModal('confirmModal', true);
        };

        window.blockUser = async (userId) => {
            try {
                const blockRef = doc(db, 'artifacts', appId, 'public', 'data', 'blocked_users', userId);
                await setDoc(blockRef, { blockedAt: Date.now() });
                window.toggleModal('confirmModal', false);
                window.showToast("User Blacklisted");
            } catch (err) {
                window.showToast("Block Failed");
            }
        };

        window.unblockUser = async (userId) => {
            try {
                const blockRef = doc(db, 'artifacts', appId, 'public', 'data', 'blocked_users', userId);
                await deleteDoc(blockRef);
                window.toggleModal('confirmModal', false);
                window.showToast("User Restored");
            } catch (err) {
                window.showToast("Restore Failed");
            }
        };

        window.deleteListing = async (id) => {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'listings', id);
                await deleteDoc(docRef);
                window.toggleModal('confirmModal', false);
                window.showToast("Listing scrubbed from DB");
            } catch (err) {
                console.error(err);
                window.showToast("Scrub Failed");
            }
        };

        window.openItemDetails = (id) => {
            const item = items.find(i => i.id === id);
            if(!item) return;
            document.getElementById('detailsImg').src = item.images?.[0] || '';
            document.getElementById('detailsName').textContent = item.name;
            document.getElementById('detailsCategory').textContent = item.category;
            document.getElementById('detailsPrice').textContent = `â‚¹${item.price}`;
            document.getElementById('detailsDesc').textContent = item.description;
            document.getElementById('detailsEmailLink').href = `mailto:${item.email}`;
            window.toggleModal('itemDetailsModal', true);
        };

        window.handleNewListingClick = () => {
            if (!window.isUserVerified) return window.showToast('Verify Identity via Email First');
            window.toggleModal('sellingModal', true);
        };

        window.setFilter = (cat) => {
            currentFilter = cat;
            document.querySelectorAll('.cat-pill').forEach(b => b.classList.toggle('active', b.textContent.includes(cat) || (cat==='ALL' && b.textContent==='All Assets')));
            updateUI();
        };

        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (user) {
                // Listen for Listings
                const qListings = collection(db, 'artifacts', appId, 'public', 'data', 'listings');
                onSnapshot(qListings, (snap) => {
                    items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateUI();
                });

                // Listen for Blocked Users
                const qBlocked = collection(db, 'artifacts', appId, 'public', 'data', 'blocked_users');
                onSnapshot(qBlocked, (snap) => {
                    blockedUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateUI();
                });

                if (window.isUserVerified) checkProfile(user);
            }
        });

        signInAnonymously(auth).catch(e => console.error("Auth Failure", e));
    </script>
</body>
</html>
